import { Scene, Engine } from './index'
import KeyWatcher from './keys'
import * as UI from './ui'
import * as Opt from './options'

import {
  Entity, Stage,
  Player, Enemy,
  Cell, Grid,
  Pathfinder, Heap,
} from '../entities'

let seed;

export default class Game {
  constructor() {
    this.characters = []
    this.gameLog = {}
  }

  init() {
    this.scene  = new Scene(0, 0)
    this.engine = new Engine(1000/30, this.scene.render, this.scene.update)

    this.populateScene()

    this.scene.resize()

    this.engine.play()
  }

  resetScene() {
    this.scene.resetScene()
    delete this.scene
    this.characters = []
    this.gameLog = {}
    this.scene = new Scene(0, 0)
    this.engine.update = this.scene.update
    this.engine.render = this.scene.render
    this.populateScene()
  }


  populateScene() {
    Opt.stage.cellSize = Opt.cellSize
    this.stage = new Stage(Opt.stage)
    this.scene.add([this.stage])

    this.stage.init(seed)
    this.addCharacters()
  }

  addCharacters() {
    this.createPlayer()
    this.createNPCs()

    this.scene.add(this.characters)
  }

  createPlayer() {
    const cell = this.stage.parseYX(this.stage.getRandomCell())
    Opt.player.x = cell.x
    Opt.player.y = cell.y
    Opt.player.width  = Opt.cellSize > 2 ? Opt.cellSize - 2 : Opt.cellSize - 1
    Opt.player.height = Opt.cellSize > 2 ? Opt.cellSize - 2 : Opt.cellSize - 1
    this.player = new Player(Opt.player)
    this.player.id = this.logEntity(this.player.logType)
    this.player.watchKeys()
    this.characters.push(this.player)
  }

  createNPCs() {
    this.createEnemies(Opt.numEnemies)
  }

  createEnemies(numEnemies) {
    let cell
    let enemy
    for (let i = 0; i < numEnemies; i++) {
      cell  = this.stage.parseYX(this.stage.getRandomCell())
      Opt.enemy.x = cell.x
      Opt.enemy.y = cell.y
      Opt.enemy.width  = Opt.cellSize > 2 ? Opt.cellSize - 2 : Opt.cellSize - 1
      Opt.enemy.height = Opt.cellSize > 2 ? Opt.cellSize - 2 : Opt.cellSize - 1
      enemy = new Enemy(Opt.enemy)
      enemy.id = this.logEntity(enemy.logType)
      enemy.target = this.player
      enemy.watchKeys()
      this.characters.push(enemy)
    }
  }

  logEntity(entityType) {
    if (!this.gameLog[entityType]) {
      this.gameLog[entityType] = 0
    }
    this.gameLog[entityType]++
    return `${entityType}-${this.gameLog[entityType]}`
  }
}


seed = "0,0..0,10..0,20..0,30..0,40..0,50..0,60..0,70..0,80..0,90..0,100..0,110..0,120..0,130..0,140..0,150..0,160..0,170..0,180..0,190..0,200..0,210..0,220..0,230..0,240..0,250..0,260..0,270..0,280..0,290..0,300..0,310..0,320..0,330..0,340..0,350..0,360..0,370..0,380..0,390..0,400..0,410..0,420..0,430..0,440..0,450..0,460..0,470..0,480..0,490..0,500..0,510..0,520..0,530..0,540..0,550..0,560..0,570..0,580..0,590..0,600..0,610..0,620..0,630..0,640..0,650..0,660..0,670..0,680..0,690..0,700..0,710..10,0..10,710..20,0..20,710..30,0..30,710..40,0..40,710..50,0..50,710..60,0..60,710..70,0..70,710..80,0..80,710..90,0..90,710..100,0..100,710..110,0..110,710..120,0..120,710..130,0..130,710..140,0..140,710..150,0..150,710..160,0..160,710..170,0..170,710..180,0..180,710..190,0..190,710..200,0..200,710..210,0..210,710..220,0..220,710..230,0..230,710..240,0..240,710..250,0..250,710..260,0..260,710..270,0..270,710..280,0..280,710..290,0..290,710..300,0..300,710..310,0..310,710..320,0..320,710..330,0..330,710..340,0..340,710..350,0..350,710..360,0..360,710..370,0..370,710..380,0..380,710..390,0..390,710..400,0..400,710..410,0..410,710..420,0..420,710..430,0..430,710..440,0..440,710..450,0..450,710..460,0..460,710..470,0..470,10..470,20..470,30..470,40..470,50..470,60..470,70..470,80..470,90..470,100..470,110..470,120..470,130..470,140..470,150..470,160..470,170..470,180..470,190..470,200..470,210..470,220..470,230..470,240..470,250..470,260..470,270..470,280..470,290..470,300..470,310..470,320..470,330..470,340..470,350..470,360..470,370..470,380..470,390..470,400..470,410..470,420..470,430..470,440..470,450..470,460..470,470..470,480..470,490..470,500..470,510..470,520..470,530..470,540..470,550..470,560..470,570..470,580..470,590..470,600..470,610..470,620..470,630..470,640..470,650..470,660..470,670..470,680..470,690..470,700..470,710..30,610..20,620..30,610..40,600..30,590..20,600..30,590..40,580..30,570..20,580..380,530..370,540..360,550..350,560..340,550..350,560..340,550..350,560..360,570..350,580..270,650..260,660..250,650..240,660..250,670..240,680..250,690..240,700..230,690..240,700..40,610..30,620..40,610..30,600..40,610..30,600..40,590..30,600..20,590..30,580..160,480..170,470..160,480..150,470..140,480..150,490..160,480..170,470..160,480..150,470..440,150..430,140..440,130..450,120..460,130..470,140..460,130..470,120..460,130..450,140..50,430..60,420..50,430..40,440..30,430..20,420..30,410..40,420..50,410..40,400..50,490..40,480..30,470..40,480..50,490..60,480..70,470..80,480..70,470..80,460..150,560..160,570..170,560..180,550..170,540..160,530..150,520..160,530..150,520..140,530..250,220..240,230..250,220..260,230..270,240..280,250..270,260..260,270..270,260..260,270..90,430..100,440..110,430..120,420..110,410..120,400..130,390..120,400..110,410..100,400..140,400..150,390..160,380..170,370..180,360..170,350..160,360..170,370..160,380..170,370..390,330..380,320..370,330..360,340..350,350..360,340..350,330..360,340..370,350..360,360..310,230..300,220..290,210..280,220..290,210..300,200..290,210..280,220..270,210..280,200..310,130..300,140..290,130..280,140..270,130..260,140..250,150..240,140..250,150..260,140..220,540..230,530..240,520..230,510..240,520..230,510..240,500..230,490..240,500..250,510..400,80..390,90..400,100..410,110..400,120..390,110..380,100..390,90..380,100..370,110..430,610..440,620..450,630..460,640..470,630..470,640..460,650..450,660..460,650..470,660..50,170..60,180..50,170..40,160..30,170..20,160..30,150..40,160..30,150..40,140..100,70..90,80..80,90..90,100..80,110..90,120..100,110..90,120..100,110..110,100..340,200..330,190..340,180..330,190..340,180..350,170..340,180..350,190..360,180..370,190..30,550..40,540..30,550..20,560..10,570..310,580..320,590..330,580..320,590..310,600..110,650..120,660..110,670..120,680..110,690..120,680..130,690..140,700..130,710..140,700..220,220..230,210..220,220..230,230..240,220..230,230..220,240..230,230..240,240..250,250..200,300..210,310..220,320..230,330..220,320..210,330..200,320..190,330..180,320..190,330..160,550..170,560..160,550..150,540..140,550..130,560..120,550..130,540..140,530..150,540..230,380..220,370..230,380..220,370..230,360..240,350..250,360..260,350..270,340..260,330..460,570..470,560..460,550..470,540..460,530..450,520..440,510..430,500..440,510..430,500..330,370..320,380..310,390..300,400..290,390..300,400..310,390..300,380..310,390..300,400..220,30..210,20..220,30..210,40..200,30..210,20..200,30..210,20..220,10..230,30..110,170..120,180..110,170..100,180..90,170..80,180..70,170..80,180..70,190..80,180..80,20..90,10..100,280..110,270..100,280..90,270..100,260..90,270..80,280..70,270..120,130..110,140..120,130..130,140..120,130..110,140..100,150..90,140..80,150..90,160..420,700..410,690..400,680..410,670..420,680..430,690..420,700..410,690..400,700..410,690..240,550..230,560..240,550..230,540..220,550..210,540..200,530..210,540..200,530..210,540..450,580..460,570..470,560..470,570..460,580..470,590..460,580..470,590..470,600..460,610..50,80..40,90..30,100..40,90..30,80..40,70..50,80..40,70..50,80..60,90..340,120..330,130..340,120..330,110..340,120..330,110..340,120..350,130..360,120..350,110..260,80..270,70..260,80..250,70..240,80..250,90..260,100..250,110..240,100..250,110..320,680..330,670..340,660..350,650..340,640..330,630..320,640..310,630..320,620..310,610..400,370..410,360..420,370..430,380..420,370..410,380..400,370..410,360..400,370..410,380..270,60..280,70..270,60..260,70..270,80..280,70..290,60..280,70..270,80..260,70..180,630..190,640..180,630..170,620..160,610..170,620..180,630..170,620..160,610..170,620..150,320..140,330..150,340..160,350..170,360..160,370..170,360..160,370..150,380..140,390..30,380..40,370..30,380..40,370..30,380..40,390..30,400..20,390..10,380..380,370..420,70..430,80..440,70..450,80..460,90..450,100..460,110..450,100..460,90..470,80..30,260..20,270..30,260..20,270..30,280..20,270..10,280..240,290..250,280..240,270..430,590..420,600..410,590..400,580..410,590..400,580..390,570..380,560..390,570..400,560..40,350..30,340..40,350..30,340..20,350..10,360..20,370..10,360..20,350..30,340..220,300..210,290..200,280..210,270..200,260..190,250..200,240..210,250..220,260..210,270..420,350..430,340..420,350..430,340..420,330..430,320..420,330..430,320..440,310..430,320..160,330..170,340..160,330..150,340..140,330..150,340..160,350..170,360..180,350..190,340..250,380..260,370..270,360..280,350..290,340..300,330..290,320..300,310..310,320..300,330..90,700..100,690..110,700..100,690..90,680..80,690..70,700..80,710..90,700..80,690..420,80..430,90..420,80..430,90..420,80..430,70..440,60..450,50..460,60..470,50..70,420..80,410..90,420..100,410..110,420..120,410..130,400..140,390..130,380..140,390..100,380..90,390..100,380..90,390..80,380..90,370..80,360..70,350..80,360..90,370..90,260..100,270..90,280..100,290..110,280..120,290..130,280..140,290..150,280..140,270..320,470..310,480..320,470..310,460..300,470..310,480..320,470..310,480..300,490..290,480..390,280..380,290..390,300..400,290..410,300..420,310..430,300..440,310..430,320..420,330..300,590..310,600..320,610..310,620..320,610..310,620..320,630..310,640..300,650..290,660..140,350..130,340..120,330..130,340..120,330..110,340..120,350..130,360..120,370..130,360..200,410..210,400..220,410..210,400..200,390..190,400..200,390..190,380..200,390..190,380..340,160..350,150..360,160..370,170..360,180..350,190..360,200..350,190..340,200..350,210..370,530..380,540..390,550..400,560..390,570..400,580..390,570..400,580..410,570..420,580..180,40..190,50..180,40..170,50..180,60..170,70..160,60..150,70..160,60..170,70..220,700..210,690..200,700..190,710..180,700..190,710..200,710..190,700..180,690..170,700..280,190..270,180..260,170..270,180..260,170..270,180..280,190..270,180..280,190..290,200..280,530..290,540..280,550..290,540..280,550..270,540..280,550..270,560..260,570..270,580..180,110..190,100..180,90..170,80..160,90..150,100..140,90..150,100..160,90..150,80..360,390..350,380..340,370..330,360..340,370..330,360..340,370..350,360..340,370..350,360..80,680..70,670..80,680..70,670..60,660..50,650..60,640..70,630..60,640..50,630..440,530..430,520..420,530..430,540..420,550..410,540..400,530..410,520..420,530..430,540..120,380..130,390..120,400..110,390..100,400..90,390..80,400..90,410..80,400..70,410..370,410..380,400..390,410..380,400..370,390..380,400..390,390..380,380..370,390..380,400..20,170..30,180..20,170..10,180..20,190..30,180..20,170..30,160..40,170..50,160..290,460..300,450..310,440..320,450..330,440..340,430..330,420..340,430..350,440..360,430..190,630..180,640..170,630..180,620..170,630..180,640..170,650..180,660..190,650..200,660..300,60..310,70..300,80..290,90..300,100..310,110..320,120..330,130..320,140..330,150..80,350..90,340..100,350..90,360..100,350..110,360..100,350..110,360..100,350..110,340..130,60..140,50..150,60..160,70..150,60..140,70..150,80..160,70..170,60..180,50..190,480..180,470..190,460..200,470..210,460..220,450..210,460..200,470..190,480..180,490..150,300..160,310..170,320..180,310..170,300..180,290..170,300..160,290..170,280..160,290..330,40..340,50..330,60..320,50..330,60..320,70..310,60..300,50..310,60..320,50..180,300..170,310..180,300..170,310..160,320..150,310..160,300..150,290..160,280..170,290..40,680..50,670..40,660..50,650..40,660..30,670..20,660..30,670..20,680..10,690..210,560..200,570..190,580..180,590..190,600..200,590..210,580..220,570..230,580..240,590..170,270..160,280..170,270..180,280..190,290..180,280..170,270..180,280..190,270..200,280..60,690..70,700..60,710..70,710..80,710..90,700..80,710..90,710..80,700..70,710..250,530..260,520..270,510..260,500..270,510..280,500..290,510..300,500..310,490..300,480..100,510..110,500..120,490..110,500..120,490..110,500..120,490..130,500..120,510..110,520..170,480..160,470..170,480..160,470..170,460..160,470..170,460..180,450..170,460..180,450..190,150..200,160..190,150..200,160..190,170..200,160..210,170..220,160..230,170..220,160..430,160..440,170..450,180..460,170..450,160..460,150..450,160..440,170..430,160..420,150..400,520..390,510..400,500..410,490..420,480..410,470..420,460..410,470..400,480..390,490..150,110..160,120..150,110..140,100..130,90..140,80..130,70..140,60..150,70..160,60..220,70..210,60..220,50..210,60..200,50..210,60..200,70..190,60..180,70..170,80..80,190..90,180..100,170..110,180..120,170..110,160..100,150..90,160..100,150..90,140..170,380..160,370..150,360..140,350..130,340..120,350..110,340..100,350..110,340..120,330..290,160..280,150..270,140..280,150..270,140..280,130..290,140..280,130..270,120..280,130.."
